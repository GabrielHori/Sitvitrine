<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Hub - Horizon IT</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background: #0a0a0a;
            color: #fff;
            margin: 0;
        }

        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: linear-gradient(135deg, #1a1a1a, #222);
            border-radius: 15px;
            border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .login-form h1 {
            text-align: center;
            margin-bottom: 25px;
        }

        .admin-hub {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: #1a1a1a;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            border: 1px solid #333;
            border-bottom: none;
        }

        .nav-tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #888;
            transition: all 0.3s;
            font-size: 1rem;
            font-weight: 500;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #00f0ff, #00b4d8);
            color: #000;
            font-weight: 600;
        }

        .nav-tab:hover:not(.active) {
            background: #252525;
            color: #fff;
        }

        /* Content Panels */
        .tab-content {
            background: linear-gradient(135deg, #1a1a1a, #111);
            padding: 25px;
            border-radius: 0 0 12px 12px;
            min-height: 600px;
            border: 1px solid #333;
            border-top: none;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e1e1e, #252525);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #00f0ff, #00b4d8);
        }

        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00f0ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #666;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Reviews Styles */
        .reviews-grid {
            display: grid;
            gap: 15px;
        }

        .review {
            background: linear-gradient(135deg, #1e1e1e, #252525);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            transition: all 0.3s;
        }

        .review:hover {
            border-color: #00f0ff;
            transform: translateY(-2px);
        }

        .review h3 {
            margin: 0 0 10px 0;
            color: #00f0ff;
        }

        .review p {
            margin: 8px 0;
            color: #aaa;
        }

        .pending {
            border-left: 4px solid #ffaa00;
        }

        .approved {
            border-left: 4px solid #00ff88;
        }

        .default {
            border-left: 4px solid #0088ff;
        }

        /* Leads */
        .lead {
            background: linear-gradient(135deg, #1e1e1e, #252525);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #333;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: start;
        }

        .lead .meta {
            color: #888;
            font-size: 0.9rem;
        }

        .lead .message {
            color: #ccc;
            margin: 8px 0;
            white-space: pre-line;
        }

        .lead .actions {
            display: flex;
            gap: 8px;
        }

        .lead .status-pill {
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #000;
            font-weight: 600;
        }

        .status-new {
            background: #ffaa00;
        }

        .status-contacted {
            background: #00d0ff;
        }

        .status-done {
            background: #00ff88;
            color: #003300;
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .approve {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .delete {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
        }

        .refresh {
            background: linear-gradient(135deg, #00f0ff, #00b4d8);
            color: #000;
        }

        .logout {
            background: #333;
            color: white;
        }

        .logout:hover {
            background: #ff4444;
        }

        .btn-save {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            padding: 12px 30px;
            font-size: 1rem;
        }

        /* Form Styles */
        input,
        select {
            padding: 12px 15px;
            margin: 8px 0;
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: #00f0ff;
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
        }

        label {
            display: block;
            margin-top: 15px;
            color: #888;
            font-size: 0.9rem;
        }

        .error-msg {
            color: #ff4444;
            margin: 10px 0;
        }

        .success-msg {
            color: #00ff88;
            margin: 10px 0;
        }

        /* Header */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 1.8rem;
            background: linear-gradient(135deg, #00f0ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Stats Editor */
        .stats-editor {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-input-group {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .stat-input-group h4 {
            margin: 0 0 15px 0;
            color: #00f0ff;
        }

        /* Recent Activity */
        .recent-activity {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            margin-top: 20px;
        }

        .recent-activity h3 {
            margin: 0 0 15px 0;
            color: #00f0ff;
        }

        .activity-item {
            padding: 12px;
            background: #252525;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item .name {
            color: #fff;
            font-weight: 500;
        }

        .activity-item .rating {
            color: #ffcc00;
        }

        .activity-item .date {
            color: #666;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <!-- LOGIN FORM -->
    <div id="login-form" class="login-form">
        <h1>üîê Connexion Admin</h1>
        <input type="password" id="password" placeholder="Mot de passe admin">
        <button onclick="login()">Se connecter</button>
        <div id="login-error" class="error"></div>
    </div>

    <!-- ADMIN HUB -->
    <div id="admin-hub" class="admin-hub">
        <div class="admin-header">
            <h1>üöÄ Admin Hub - Horizon IT</h1>
            <button class="logout" onclick="logout()">D√©connexion</button>
        </div>

        <!-- NAVIGATION TABS -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üè† Dashboard</button>
            <button class="nav-tab" onclick="switchTab('reviews')">üìù Avis</button>
            <button class="nav-tab" onclick="switchTab('leads')">üì© Leads</button>
            <button class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è Param√®tres</button>
        </div>

        <!-- TAB CONTENT -->
        <div class="tab-content">
            <!-- DASHBOARD PANEL -->
            <div id="dashboard-panel" class="tab-panel active">
                <div class="dashboard">
                    <div class="stat-card">
                        <h4>üìù Total Avis</h4>
                        <div class="stat-number" id="stat-total-reviews">0</div>
                        <div class="stat-label">avis re√ßus</div>
                    </div>
                    <div class="stat-card">
                        <h4>‚úÖ Approuv√©s</h4>
                        <div class="stat-number" id="stat-approved">0</div>
                        <div class="stat-label">publi√©s sur le site</div>
                    </div>
                    <div class="stat-card">
                        <h4>‚è≥ En attente</h4>
                        <div class="stat-number" id="stat-pending">0</div>
                        <div class="stat-label">√† mod√©rer</div>
                    </div>
                    <div class="stat-card">
                        <h4>‚≠ê Note moyenne</h4>
                        <div class="stat-number" id="stat-avg-rating">5.0</div>
                        <div class="stat-label">sur 5 √©toiles</div>
                    </div>
                </div>

                <div class="stat-card">
                    <h4>üì© Demandes</h4>
                    <div class="stat-number" id="stat-leads-total">0</div>
                    <div class="stat-label">devis re√ßus</div>
                </div>
                <div class="stat-card">
                    <h4>üñäÔ∏è √Ä traiter</h4>
                    <div class="stat-number" id="stat-leads-new">0</div>
                    <div class="stat-label">nouveaux leads</div>
                </div>
            </div>

            <div class="recent-activity">
                <h3>üìã Derniers avis re√ßus</h3>
                <div id="recent-reviews">Chargement...</div>
            </div>
        </div>

        <!-- REVIEWS PANEL -->
        <div id="reviews-panel" class="tab-panel">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <button class="refresh" onclick="loadReviews()">üîÑ Actualiser</button>
                    <span id="reviews-count" style="margin-left: 15px; color: #888;"></span>
                </div>
                <select id="reviews-filter" onchange="filterReviews()" style="width: auto; padding: 10px 20px;">
                    <option value="all">Tous les avis</option>
                    <option value="pending">En attente</option>
                    <option value="approved">Approuv√©s</option>
                </select>
            </div>
            <div id="reviews-container" class="reviews-grid">Chargement des avis...</div>
        </div>

        <!-- LEADS PANEL -->
        <div id="leads-panel" class="tab-panel">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <button class="refresh" onclick="loadLeads()">üîÑ Actualiser</button>
                    <span id="leads-count" style="margin-left: 15px; color: #888;"></span>
                </div>
                <select id="leads-filter" onchange="filterLeads()" style="width: auto; padding: 10px 20px;">
                    <option value="all">Tous</option>
                    <option value="new">Nouveaux</option>
                    <option value="contacted">Contact√©</option>
                    <option value="done">Cl√¥tur√©</option>
                </select>
            </div>
            <div id="leads-container" class="reviews-grid">Chargement des demandes...</div>
        </div>

        <!-- SETTINGS PANEL -->
        <div id="settings-panel" class="tab-panel">
            <h3 style="margin-bottom: 20px;">üìä Statistiques affich√©es sur le site</h3>
            <p style="color: #888; margin-bottom: 20px;">Ces valeurs sont affich√©es dans la section statistiques de
                votre site.</p>

            <div class="stats-editor">
                <div class="stat-input-group">
                    <h4>üñ•Ô∏è PC Mont√©s</h4>
                    <input type="number" id="input-pc-built" placeholder="Nombre de PC mont√©s" min="0">
                </div>
                <div class="stat-input-group">
                    <h4>üòä Clients Satisfaits</h4>
                    <input type="number" id="input-happy-clients" placeholder="Nombre de clients" min="0">
                </div>
                <div class="stat-input-group">
                    <h4>‚è±Ô∏è Temps de r√©ponse (h)</h4>
                    <input type="number" id="input-response-time" placeholder="Heures" min="1" max="72">
                </div>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn-save" onclick="saveStats()">üíæ Sauvegarder les statistiques</button>
                <span id="save-status" style="margin-left: 15px;"></span>
            </div>

            <hr style="border-color: #333; margin: 40px 0;">

            <h3 style="margin-bottom: 20px;">‚ÑπÔ∏è Informations syst√®me</h3>
            <div class="stat-card" style="max-width: 400px;">
                <p><strong>Version:</strong> 2.0.0</p>
                <p><strong>Derni√®re connexion:</strong> <span id="last-login">-</span></p>
                <p><strong>Statut:</strong> <span style="color: #00ff88;">‚úÖ Op√©rationnel</span></p>
            </div>
        </div>
    </div>
    </div>

    <script>
        let authToken = localStorage.getItem('admin-token');
        let currentTab = 'dashboard';
        let allReviews = [];
        let allLeads = [];

        // V√©rifier si d√©j√† connect√©
        if (authToken) {
            showAdminHub();
            loadDashboard();
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        async function login() {
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                const response = await fetch('/.netlify/functions/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();

                if (response.ok) {
                    authToken = result.token;
                    localStorage.setItem('admin-token', authToken);
                    localStorage.setItem('last-login', new Date().toLocaleString('fr-FR'));
                    showAdminHub();
                    loadDashboard();
                    errorDiv.textContent = '';
                } else {
                    errorDiv.textContent = result.error;
                }
            } catch (error) {
                errorDiv.textContent = 'Erreur de connexion';
            }
        }

        function showAdminHub() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('admin-hub').style.display = 'block';
            document.getElementById('last-login').textContent = localStorage.getItem('last-login') || 'Premi√®re connexion';
        }

        function logout() {
            localStorage.removeItem('admin-token');
            authToken = null;
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('admin-hub').style.display = 'none';
            document.getElementById('password').value = '';
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update panels
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabName + '-panel').classList.add('active');

            currentTab = tabName;

            // Load data for the active tab
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'reviews') loadReviews();
            if (tabName === 'leads') loadLeads();
            if (tabName === 'settings') loadSiteStats();
        }

        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            if (!authToken) return;

            try {
                const response = await fetch('/.netlify/functions/admin-stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const stats = await response.json();

                // Update stats cards
                document.getElementById('stat-total-reviews').textContent = stats.reviews.total;
                document.getElementById('stat-approved').textContent = stats.reviews.approved;
                document.getElementById('stat-pending').textContent = stats.reviews.pending;
                document.getElementById('stat-avg-rating').textContent = stats.reviews.avgRating || '5.0';
                if (stats.leads) {
                    document.getElementById('stat-leads-total').textContent = stats.leads.total ?? 0;
                    document.getElementById('stat-leads-new').textContent = stats.leads.new ?? 0;
                }

                // Update recent reviews
                displayRecentReviews(stats.recent);

                // Store site stats for settings
                if (stats.site) {
                    document.getElementById('input-pc-built').value = stats.site.pcBuilt;
                    document.getElementById('input-happy-clients').value = stats.site.happyClients;
                    document.getElementById('input-response-time').value = stats.site.responseTime;
                }

            } catch (error) {
                console.error('Erreur dashboard:', error);
            }
        }

        function displayRecentReviews(reviews) {
            const container = document.getElementById('recent-reviews');

            if (!reviews || reviews.length === 0) {
                container.innerHTML = '<p style="color: #666;">Aucun avis r√©cent</p>';
                return;
            }

            container.innerHTML = reviews.map(r => `
                <div class="activity-item">
                    <span class="name">${r.name}</span>
                    <span class="rating">${'‚≠ê'.repeat(r.rating)}</span>
                    <span class="date">${new Date(r.created_at).toLocaleDateString('fr-FR')}</span>
                    <span style="color: ${r.approved ? '#00ff88' : '#ffaa00'};">${r.approved ? '‚úÖ' : '‚è≥'}</span>
                </div>
            `).join('');
        }

        // ============================================
        // REVIEWS MANAGEMENT
        // ============================================
        async function loadReviews() {
            if (!authToken) return;

            try {
                const response = await fetch('/.netlify/functions/admin-reviews', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    allReviews = await response.json();
                    filterReviews();
                } else if (response.status === 401) {
                    logout();
                } else {
                    document.getElementById('reviews-container').innerHTML = '<p style="color: #ff4444;">Erreur lors du chargement</p>';
                }
            } catch (error) {
                document.getElementById('reviews-container').innerHTML = '<p style="color: #ff4444;">Erreur de connexion</p>';
            }
        }

        function filterReviews() {
            const filter = document.getElementById('reviews-filter').value;
            let filtered = allReviews;

            if (filter === 'pending') {
                filtered = allReviews.filter(r => !r.approved);
            } else if (filter === 'approved') {
                filtered = allReviews.filter(r => r.approved);
            }

            displayAdminReviews(filtered);
        }

        function displayAdminReviews(reviews) {
            const container = document.getElementById('reviews-container');
            const countSpan = document.getElementById('reviews-count');

            const pending = allReviews.filter(r => !r.approved).length;
            const approved = allReviews.filter(r => r.approved).length;
            countSpan.textContent = `${allReviews.length} total ‚Ä¢ ${pending} en attente ‚Ä¢ ${approved} approuv√©s`;

            if (reviews.length === 0) {
                container.innerHTML = '<p style="color: #666;">Aucun avis correspondant.</p>';
                return;
            }

            container.innerHTML = reviews.map(review => `
                <div class="review ${review.approved ? 'approved' : 'pending'} ${review.isDefault ? 'default' : ''}">
                    <h3>${review.name} ${'‚≠ê'.repeat(review.rating)} ${review.isDefault ? '<span style="color: #0088ff;">(Par d√©faut)</span>' : ''}</h3>
                    <p><strong>Service:</strong> ${review.service || 'Non sp√©cifi√©'}</p>
                    <p style="font-style: italic; color: #ccc;">"${review.text}"</p>
                    <p><small style="color: #666;">${review.date || new Date(review.created_at).toLocaleDateString('fr-FR')} ‚Ä¢ ${review.approved ? '<span style="color: #00ff88;">‚úÖ Approuv√©</span>' : '<span style="color: #ffaa00;">‚è≥ En attente</span>'}</small></p>
                    <div style="margin-top: 10px;">
                        ${!review.approved ? `<button class="approve" onclick="approveReview(${review.id})">‚úÖ Approuver</button>` : ''}
                        <button class="delete" onclick="deleteReview(${review.id}, '${review.name}')">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        async function approveReview(id) {
            await adminAction('approve', id);
        }

        async function deleteReview(id, name) {
            if (confirm(`Supprimer l'avis de ${name} ?`)) {
                await adminAction('delete', id);
            }
        }

        async function adminAction(action, reviewId) {
            try {
                const response = await fetch('/.netlify/functions/admin-reviews', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, reviewId })
                });

                if (response.ok) {
                    loadReviews();
                } else if (response.status === 401) {
                    logout();
                } else {
                    alert('Erreur lors de l\'action');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // ============================================
        // LEADS MANAGEMENT
        // ============================================
        async function loadLeads() {
            if (!authToken) return;

            try {
                const response = await fetch('/.netlify/functions/admin-leads', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    allLeads = await response.json();
                    filterLeads();
                } else if (response.status === 401) {
                    logout();
                } else {
                    document.getElementById('leads-container').innerHTML = '<p style="color: #ff4444;">Erreur lors du chargement</p>';
                }
            } catch (error) {
                document.getElementById('leads-container').innerHTML = '<p style="color: #ff4444;">Erreur de connexion</p>';
            }
        }

        function filterLeads() {
            const filter = document.getElementById('leads-filter').value;
            let filtered = allLeads;

            if (filter !== 'all') {
                filtered = allLeads.filter(l => l.status === filter);
            }

            displayLeads(filtered);
        }

        function displayLeads(leads) {
            const container = document.getElementById('leads-container');
            const countSpan = document.getElementById('leads-count');

            const countNew = allLeads.filter(l => l.status === 'new').length;
            const countContacted = allLeads.filter(l => l.status === 'contacted').length;
            const countDone = allLeads.filter(l => l.status === 'done').length;
            countSpan.textContent = `${allLeads.length} total ‚Ä¢ ${countNew} nouveaux ‚Ä¢ ${countContacted} contact√©s ‚Ä¢ ${countDone} cl√¥tur√©s`;

            if (!leads || leads.length === 0) {
                container.innerHTML = '<p style="color: #666;">Aucune demande.</p>';
                return;
            }

            container.innerHTML = leads.map(lead => {
                const statusClass = lead.status ? `status-${lead.status}` : 'status-new';
                const statusLabel = lead.status === 'done' ? 'Cl√¥tur√©' : lead.status === 'contacted' ? 'Contact√©' : 'Nouveau';
                const date = lead.created_at ? new Date(lead.created_at).toLocaleString('fr-FR') : '';
                return `
                    <div class="lead">
                        <div>
                            <div><strong>${lead.name || 'Sans nom'}</strong> ‚Ä¢ <span class="meta">${lead.email || 'N/A'}</span></div>
                            <div class="meta">Service: ${lead.service || 'Non sp√©cifi√©'} ‚Ä¢ ${date}</div>
                            <div class="message">${lead.message || ''}</div>
                        </div>
                        <div class="actions">
                            <span class="status-pill ${statusClass}">${statusLabel}</span>
                            ${lead.status !== 'contacted' ? `<button class="approve" onclick="updateLead(${lead.id}, 'contacted')">üìû Contact√©</button>` : ''}
                            ${lead.status !== 'done' ? `<button class="approve" onclick="updateLead(${lead.id}, 'done')">‚úÖ Cl√¥turer</button>` : ''}
                            <button class="delete" onclick="deleteLead(${lead.id}, '${lead.name || ''}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateLead(id, status) {
            await leadAction('update', id, status);
        }

        async function deleteLead(id, name) {
            if (confirm(`Supprimer la demande de ${name || 'ce contact'} ?`)) {
                await leadAction('delete', id);
            }
        }

        async function leadAction(action, leadId, status = null) {
            try {
                const response = await fetch('/.netlify/functions/admin-leads', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, leadId, status })
                });

                if (response.ok) {
                    loadLeads();
                } else if (response.status === 401) {
                    logout();
                } else {
                    alert('Erreur lors de l\'action lead');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // ============================================
        // SETTINGS - SITE STATS
        // ============================================
        async function loadSiteStats() {
            if (!authToken) return;

            try {
                const response = await fetch('/.netlify/functions/admin-stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.site) {
                        document.getElementById('input-pc-built').value = data.site.pcBuilt || 50;
                        document.getElementById('input-happy-clients').value = data.site.happyClients || 100;
                        document.getElementById('input-response-time').value = data.site.responseTime || 24;
                    }
                }
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        async function saveStats() {
            if (!authToken) return;

            const statusSpan = document.getElementById('save-status');
            statusSpan.textContent = '‚è≥ Sauvegarde...';
            statusSpan.style.color = '#ffaa00';

            const pcBuilt = parseInt(document.getElementById('input-pc-built').value) || 50;
            const happyClients = parseInt(document.getElementById('input-happy-clients').value) || 100;
            const responseTime = parseInt(document.getElementById('input-response-time').value) || 24;

            try {
                const response = await fetch('/.netlify/functions/admin-stats', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pcBuilt, happyClients, responseTime })
                });

                if (response.ok) {
                    statusSpan.textContent = '‚úÖ Sauvegard√© !';
                    statusSpan.style.color = '#00ff88';
                    setTimeout(() => { statusSpan.textContent = ''; }, 3000);
                } else {
                    throw new Error('Erreur serveur');
                }
            } catch (error) {
                statusSpan.textContent = '‚ùå Erreur de sauvegarde';
                statusSpan.style.color = '#ff4444';
            }
        }

        // ============================================
        // AUTO-REFRESH
        // ============================================
        setInterval(() => {
            if (currentTab === 'dashboard') loadDashboard();
            if (currentTab === 'reviews') loadReviews();
            if (currentTab === 'leads') loadLeads();
        }, 30000); // Refresh toutes les 30 secondes

        // Connexion avec Enter
        document.getElementById('password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>

</html>